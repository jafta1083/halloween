from flask import Flask, render_template_string, request, jsonify, session, redirect, url_for
import json
import os
import random
from datetime import datetime
import time
import subprocess
import platform

app = Flask(__name__)
app.secret_key = 'halloween2025'  # Required for session management

# HTML template with CSS for styling
TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Halloween Quiz ðŸŽƒ</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ff9933;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            text-align: center;
        }
        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #ff4b4b;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .question {
            font-size: 24px;
            margin: 20px 0;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .option {
            padding: 10px 20px;
            background-color: #333;
            border: none;
            color: #ff9933;
            cursor: pointer;
            border-radius: 5px;
            font-size: 18px;
            transition: background-color 0.3s;
        }
        .option:hover {
            background-color: #444;
        }
        .score {
            font-size: 24px;
            margin: 20px 0;
        }
        pre {
            color: #ff9933;
            font-size: 14px;
            margin: 20px 0;
        }
        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        .category-checkbox {
            display: none;
        }
        .category-label {
            padding: 10px 20px;
            background-color: #333;
            color: #ff9933;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        .category-checkbox:checked + .category-label {
            background-color: #ff4b4b;
        }
    </style>
</head>
<body>
    <div class="container">
        <pre>
     ____                        
    |    |                     ðŸŽƒ Halloween
   /      \\                    Quiz Game
  |  O  O  |                   
  |   ^    |                   Get ready
   \\  --  /                    for some
    `----'                     spooky fun!
        </pre>
        
        {% if not session.get('game_started') %}
            <h2>Welcome to the Halloween Quiz! ðŸ‘»</h2>
            <form method="POST" action="/start">
                <input type="text" name="player_name" placeholder="Enter your name" required>
                <br><br>
                <select name="difficulty" class="option">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <br><br>
                <div class="categories">
                    {% for cat_id, cat_name in categories.items() %}
                    <div>
                        <input type="checkbox" name="category" value="{{ cat_id }}"
                               id="cat_{{ cat_id }}" class="category-checkbox" checked>
                        <label for="cat_{{ cat_id }}" class="category-label">{{ cat_name }}</label>
                    </div>
                    {% endfor %}
                </div>
                <br>
                <button class="option" type="submit">Start Game</button>
            </form>
        {% elif session.get('game_over') %}
            <h2>Game Over! ðŸŽƒ</h2>
            <div class="score">Final Score: {{ session.get('score', 0) }}</div>
            <br>
            <form method="GET" action="/">
                <button class="option" type="submit">Play Again</button>
            </form>
        {% else %}
            <div class="timer" id="timer">{{ session.get('timer', 30) }}</div>
            <div class="score">Score: {{ session.get('score', 0) }}</div>
            <div class="question">{{ question }}</div>
            <form class="options" method="POST" action="/answer">
                {% for option in options %}
                    <button class="option" type="submit" name="answer" value="{{ loop.index0 }}">
                        {{ option }}
                    </button>
                {% endfor %}
            </form>
        {% endif %}
    </div>
    
    {% if session.get('game_started') and not session.get('game_over') %}
    <script>
        // Countdown timer
        let timeLeft = {{ session.get('timer', 30) }};
        const timerElement = document.getElementById('timer');
        
        const timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                document.forms[0].submit();
            }
        }, 1000);
    </script>
    {% endif %}
</body>
</html>
"""

def play_sound(sound_type):
    """Play sound using system audio player."""
    sound_file = os.path.join(os.path.dirname(__file__), f'../assets/sounds/{sound_type}.mp3')
    if os.path.exists(sound_file):
        if platform.system() == 'Linux':
            subprocess.Popen(['paplay', sound_file], stderr=subprocess.DEVNULL)
        elif platform.system() == 'Darwin':  # macOS
            subprocess.Popen(['afplay', sound_file], stderr=subprocess.DEVNULL)

def load_questions():
    """Load questions from the JSON file."""
    questions_file = os.path.join(os.path.dirname(__file__), '../assets/questions.json')
    with open(questions_file, 'r') as f:
        return json.load(f)

class HalloweenQuizWeb:
    def __init__(self):
        self.categories = {
            'spooky': 'Spooky Stories and Urban Legends',
            'costumes': 'Halloween Costumes and Traditions',
            'movies': 'Horror Movies and Characters',
            'history': 'Halloween History and Facts',
            'candy': 'Halloween Candy and Treats',
            'paranormal': 'Paranormal Activity'
        }
        self.difficulties = ['easy', 'medium', 'hard']
        self.questions = load_questions()

    def get_category_questions(self, selected_categories, difficulty):
        """Get questions from selected categories based on difficulty."""
        selected_questions = []
        for category in selected_categories:
            category_questions = self.questions.get(category, [])
            difficulty_questions = [q for q in category_questions 
                                 if q.get('difficulty', 'medium') == difficulty]
            selected_questions.extend(difficulty_questions)
        
        if not selected_questions:  # Fallback if no questions for selected difficulty
            for category in selected_categories:
                selected_questions.extend(self.questions.get(category, []))
        
        random.shuffle(selected_questions)
        return selected_questions[:10]  # Limit to 10 questions per game

if __name__ == '__main__':
    # Ensure the sounds directory exists
    os.makedirs(os.path.join(os.path.dirname(__file__), '../assets/sounds'), exist_ok=True)
    
    # Start the Flask development server
    app.run(debug=True, host='127.0.0.1', port=5000)
        <style>
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #ff4b4b;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .stProgress > div > div > div > div {
            background-color: #ff4b4b;
        }
        </style>
    """, unsafe_allow_html=True)
    
    # Initialize game state
    if 'game' not in st.session_state:
        st.session_state.game = HalloweenQuizWeb()
    if 'current_question' not in st.session_state:
        st.session_state.current_question = 0
    if 'score' not in st.session_state:
        st.session_state.score = 0
    if 'timer' not in st.session_state:
        st.session_state.timer = 30
    if 'last_tick' not in st.session_state:
        st.session_state.last_tick = time.time()
    if 'game_active' not in st.session_state:
        st.session_state.game_active = False
    
    # Halloween ASCII art header
    st.markdown("""
    ```
     ____                        
    |    |                     ðŸŽƒ Halloween
   /     \\                    Quiz Game
  |  O  O  |                   
  |   ^    |                   Get ready
   \\  --  /                    for some
    `----`                     spooky fun!
    ```
    """)
    
    # Update timer if game is active
    if st.session_state.game_active:
        current_time = time.time()
        if current_time - st.session_state.last_tick >= 1:
            st.session_state.timer -= int(current_time - st.session_state.last_tick)
            st.session_state.last_tick = current_time
    if 'questions' not in st.session_state:
        st.session_state.questions = []
    if 'game_started' not in st.session_state:
        st.session_state.game_started = False
    if 'time_remaining' not in st.session_state:
        st.session_state.time_remaining = 0
    if 'game_over' not in st.session_state:
        st.session_state.game_over = False

    # New Flask Web App
    st.markdown("""
    <style>
    .big-font {
        font-size:50px !important;
        font-weight:bold;
        color:#ff6b00;
        text-align:center;
    }
    .score-font {
        font-size:24px;
        color:#ff6b00;
        text-align:center;
    }
    </style>
    """, unsafe_allow_html=True)
    
    st.markdown('<p class="big-font">ðŸŽƒ Halloween Quiz ðŸŽƒ</p>', unsafe_allow_html=True)

    if not st.session_state.game_started:
        # Game setup
        with st.form("game_setup"):
            st.write("### Welcome to the Halloween Quiz! ðŸ‘»")
            name = st.text_input("Enter your name, brave soul:", placeholder="Your spooky name")
            
            # Category selection
            st.write("### Choose your categories:")
            categories = {}
            for key, value in st.session_state.game.categories.items():
                categories[key] = st.checkbox(value, True)
            
            # Difficulty selection
            difficulty = st.selectbox(
                "Choose your difficulty:",
                ["easy", "medium", "hard"],
                index=1
            )
            
            submit = st.form_submit_button("Start Quiz!")
            
            if submit:
                if not name:
                    st.error("Please enter your name!")
                    return
                if not any(categories.values()):
                    st.error("Please select at least one category!")
                    return
                
                selected_categories = [k for k, v in categories.items() if v]
                st.session_state.questions = st.session_state.game.get_category_questions(
                    selected_categories, difficulty
                )
                st.session_state.player_name = name
                st.session_state.difficulty = difficulty
                st.session_state.game_started = True
                st.session_state.time_remaining = {"easy": 45, "medium": 30, "hard": 20}[difficulty]
                st.experimental_rerun()
    
    elif not st.session_state.game_over:
        # Display score
        st.markdown(
            f'<p class="score-font">Score: {st.session_state.score}/{st.session_state.current_question}</p>',
            unsafe_allow_html=True
        )
        
        # Display progress
        progress = st.session_state.current_question / len(st.session_state.questions)
        st.progress(progress)
        
        # Display current question
        if st.session_state.current_question < len(st.session_state.questions):
            question = st.session_state.questions[st.session_state.current_question]
            
            # Timer
            if st.session_state.time_remaining > 0:
                st.write(f"â±ï¸ Time remaining: {st.session_state.time_remaining} seconds")
                time.sleep(1)
                st.session_state.time_remaining -= 1
                if st.session_state.time_remaining > 0:
                    st.experimental_rerun()
            
            st.write(f"### Question {st.session_state.current_question + 1}:")
            st.write(question["question"])
            
            # Answer buttons
            for i, option in enumerate(question["options"]):
                if st.button(option, key=f"option_{i}"):
                    if option == question["correct_answer"]:
                        st.success("âœ¨ Correct! You're scarily good at this!")
                        bonus = {"easy": 1, "medium": 2, "hard": 3}[st.session_state.difficulty]
                        st.session_state.score += bonus
                    else:
                        st.error(f"ðŸ‘» Oops! The correct answer was: {question['correct_answer']}")
                    
                    # Move to next question
                    st.session_state.current_question += 1
                    st.session_state.time_remaining = {
                        "easy": 45, "medium": 30, "hard": 20
                    }[st.session_state.difficulty]
                    
                    if st.session_state.current_question >= len(st.session_state.questions):
                        st.session_state.game_over = True
                    st.experimental_rerun()
            
            # Time's up
            if st.session_state.time_remaining <= 0:
                st.warning("â° Time's up! Moving to next question...")
                st.session_state.current_question += 1
                st.session_state.time_remaining = {
                    "easy": 45, "medium": 30, "hard": 20
                }[st.session_state.difficulty]
                
                if st.session_state.current_question >= len(st.session_state.questions):
                    st.session_state.game_over = True
                st.experimental_rerun()
    
    else:
        # Game over screen
        max_score = len(st.session_state.questions) * {
            "easy": 1, "medium": 2, "hard": 3
        }[st.session_state.difficulty]
        
        st.markdown(f'<p class="big-font">Game Over! ðŸŽƒ</p>', unsafe_allow_html=True)
        st.write(f"### Final Score: {st.session_state.score}/{max_score}")
        
        percentage = (st.session_state.score / max_score) * 100
        if percentage == 100:
            st.balloons()
            st.success("ðŸ† PERFECT SCORE! You're the Ultimate Halloween Master! ðŸ‘‘")
        elif percentage >= 80:
            st.success("ðŸŒŸ Impressive! You're truly a Halloween expert!")
        elif percentage >= 60:
            st.info("ðŸŽƒ Good job! You know your spooky stuff!")
        else:
            st.warning("ðŸ‘» Keep practicing! The spirits will guide you!")
        
        # Save score
        try:
            score_data = {
                "name": st.session_state.player_name,
                "difficulty": st.session_state.difficulty,
                "score": f"{st.session_state.score}/{max_score}",
                "percentage": f"{percentage:.1f}%",
                "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }
            
            # Save to CSV
            score_line = f"{score_data['name']},{score_data['difficulty']},{score_data['score']},{score_data['percentage']},{score_data['date']}\n"
            if not os.path.exists("high_scores.csv"):
                with open("high_scores.csv", "w") as f:
                    f.write("Name,Difficulty,Score,Percentage,Date\n")
            with open("high_scores.csv", "a") as f:
                f.write(score_line)
        except:
            st.error("Couldn't save your score, but great game anyway!")
        
        if st.button("Play Again! ðŸŽ®"):
            st.session_state.clear()
            st.experimental_rerun()

if __name__ == "__main__":
    main()